<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Mechanics: Data Cleaning and Validation Pipeline • ohcleandat</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mechanics: Data Cleaning and Validation Pipeline">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ohcleandat</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.12</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/idcheck.html">ID Correction and Autobot</a></li>
    <li><a class="dropdown-item" href="../articles/integration.html">Integrating Different Datasets</a></li>
    <li><a class="dropdown-item" href="../articles/mechanics.html">Mechanics: Data Cleaning and Validation Pipeline</a></li>
    <li><a class="dropdown-item" href="../articles/metadata.html">Metadata: Creating Standard Metadata with `{ohcleandat}` and `{deposits}`</a></li>
    <li><a class="dropdown-item" href="../articles/outputs.html">Understanding The Pipeline Outputs</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Mechanics: Data Cleaning and Validation Pipeline</h1>
            
      

      <div class="d-none name"><code>mechanics.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://One-Health-Research-Consulting.github.io/ohcleandat/" class="external-link">ohcleandat</a></span><span class="op">)</span></span></code></pre></div>
<p>This is a basic overview of the data cleaning and validation pipeline
supported by {ohcleandat} functions. The pipeline is a data analytics
workflow implemented in R, using the {targets} package.</p>
<p>In a simple case, this has four steps:</p>
<ol style="list-style-type: decimal">
<li>Reading in the data.<br>
</li>
<li>Setting up rules to validate the data.<br>
</li>
<li>The creation and use of a validation log.</li>
<li>Integrating the corrections of that log to clean the data.</li>
</ol>
<div class="section level2">
<h2 id="data-cleaning-and-validation-pipeline">Data Cleaning and Validation Pipeline<a class="anchor" aria-label="anchor" href="#data-cleaning-and-validation-pipeline"></a>
</h2>
<div class="section level3">
<h3 id="reading-raw-data">Reading raw data<a class="anchor" aria-label="anchor" href="#reading-raw-data"></a>
</h3>
<p>The raw data for this pipeline can be from a variety of sources. The
first step is to read in this data, standardize it using some
pre-processing steps and if required, combine it into one unified data
set for review.</p>
</div>
<div class="section level3">
<h3 id="validation-rules">Validation Rules<a class="anchor" aria-label="anchor" href="#validation-rules"></a>
</h3>
<p>Data validation rules are formally defined using the {validate} R
package. These rules might involve ensuring the data is within a certain
range, ensuring values are from a given input list or checking to see if
values are unique or missing.</p>
</div>
<div class="section level3">
<h3 id="validation-log">Validation Log<a class="anchor" aria-label="anchor" href="#validation-log"></a>
</h3>
<p>Once these rules have been defined, they are ‘confronted’ with the
data. Those records that do not pass the validation checks are exported
in a validation log. A validation log is a CSV output that can be sent
to subject-matter experts for manual review. During the review process,
the reviewer will indicate if an entry is valid or not, and if not, they
will provide a ‘new value’ to be corrected as well as any optional
comments.</p>
</div>
<div class="section level3">
<h3 id="integrating-corrections">Integrating corrections<a class="anchor" aria-label="anchor" href="#integrating-corrections"></a>
</h3>
<p>The final step involves correcting the data and converting it into a
‘semi-clean’ data set. This involves reading in the validation log,
scanning for any changes that are indicated, and then correcting the
existing values with the newly supplied values.</p>
<p>To ensure corrections are applied as expected, a function
<code><a href="../reference/validation_checks.html">validation_checks()</a></code> is provided to compare the before and
after data, along with the validation logs. This function will error if
the checks are not satisfied and the output when successful is the
summary output from <code><a href="https://mayoverse.github.io/arsenal/reference/comparedf.html" class="external-link">arsenal::comparedf()</a></code>.</p>
<p>A conceptual overview of this process is outlined below.</p>
<p><img src="img%2Fpipeline.png"></p>
</div>
</div>
<div class="section level2">
<h2 id="targets-implementation">Targets Implementation<a class="anchor" aria-label="anchor" href="#targets-implementation"></a>
</h2>
<div class="section level3">
<h3 id="pipeline">Pipeline<a class="anchor" aria-label="anchor" href="#pipeline"></a>
</h3>
<p>The below code sample demonstrates a typical end to end validation
pipeline. While the data pre-processing steps for any given project may
vary, much of this code can be re-used as a template for future
pipelines.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fs_mosquito_field_targets</span> <span class="op">&lt;-</span> <span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># FS mosquito field data googlesheets ids</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_field_sheets</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      fs_mosquito_21_24 <span class="op">=</span> <span class="st">"1I45IcVtYi7hOc-qum7d"</span>,</span>
<span>      fs_mosquito_19_20 <span class="op">=</span> <span class="st">"17hYyE_Rs4Z9IU-vpKTj"</span>,</span>
<span>      fs_mosquito_20_21 <span class="op">=</span> <span class="st">"1qn_N0WVTKpwv0iKzOEm"</span>,</span>
<span>      fs_mosquito_16_17 <span class="op">=</span> <span class="st">"1XAItM-YST8ZdUCU1gPH"</span>,</span>
<span>      fs_mosquito_17_18 <span class="op">=</span> <span class="st">"1GUYgEX-VA0NH2_Yko-M"</span>,</span>
<span>      fs_mosquito_18_19 <span class="op">=</span> <span class="st">"1HJv9-DOQ3sOgy3wVHoz"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># FS mosquito field data 2021-2024</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_field_raw</span>,</span>
<span>    <span class="fu">ohcleandat</span><span class="fu">::</span><span class="fu"><a href="../reference/read_googlesheets.html">read_googlesheets</a></span><span class="op">(</span></span>
<span>      key_path <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"./key.json"</span><span class="op">)</span>,</span>
<span>      ss <span class="op">=</span> <span class="va">fs_mosquito_field_sheets</span>,</span>
<span>      sheet <span class="op">=</span> <span class="st">"all"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">fs_mosquito_field_sheets</span><span class="op">)</span>,</span>
<span>    iteration <span class="op">=</span> <span class="st">"list"</span>,</span>
<span>    cue <span class="op">=</span> <span class="fu">tar_cue</span><span class="op">(</span><span class="st">"never"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># setting intuitive names for the dynamic branches of each year</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_field_raw_n</span>,</span>
<span>    <span class="fu">set_names</span><span class="op">(</span><span class="va">fs_mosquito_field_raw</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fs_mosquito_field_sheets</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># clean data</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_21_24</span>,</span>
<span>    <span class="fu">map_dfr</span><span class="op">(</span></span>
<span>      <span class="va">fs_mosquito_field_raw_n</span><span class="op">$</span><span class="va">fs_mosquito_21_24</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>      <span class="va">clean_fs_mosquito_21_24</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_19_20</span>,</span>
<span>    <span class="fu">map_dfr</span><span class="op">(</span></span>
<span>      <span class="va">fs_mosquito_field_raw_n</span><span class="op">$</span><span class="va">fs_mosquito_19_20</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>      <span class="va">clean_fs_mosquito_19_20</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_20_21</span>,</span>
<span>    <span class="fu">map_dfr</span><span class="op">(</span></span>
<span>      <span class="va">fs_mosquito_field_raw_n</span><span class="op">$</span><span class="va">fs_mosquito_20_21</span><span class="op">[</span><span class="op">-</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>      <span class="va">clean_fs_mosquito_20_21</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_16_17</span>,</span>
<span>    <span class="fu">map_dfr</span><span class="op">(</span></span>
<span>      <span class="va">fs_mosquito_field_raw_n</span><span class="op">$</span><span class="va">fs_mosquito_16_17</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">24</span>, <span class="fl">25</span><span class="op">)</span><span class="op">]</span>,</span>
<span>      <span class="va">clean_fs_mosquito_16_17</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_17_18</span>,</span>
<span>    <span class="fu">map_dfr</span><span class="op">(</span></span>
<span>      <span class="va">fs_mosquito_field_raw_n</span><span class="op">$</span><span class="va">fs_mosquito_17_18</span>,</span>
<span>      <span class="va">clean_fs_mosquito_17_18</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_18_19</span>,</span>
<span>    <span class="fu">map_dfr</span><span class="op">(</span></span>
<span>      <span class="va">fs_mosquito_field_raw_n</span><span class="op">$</span><span class="va">fs_mosquito_18_19</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">23</span><span class="op">]</span>,</span>
<span>      <span class="va">clean_fs_mosquito_18_19</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># combine all years</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_data_comb</span>,</span>
<span>    <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>      fs_mosquito_21_24 <span class="op">=</span> <span class="va">fs_mosquito_21_24</span>,</span>
<span>      fs_mosquito_19_20 <span class="op">=</span> <span class="va">fs_mosquito_19_20</span>,</span>
<span>      fs_mosquito_20_21 <span class="op">=</span> <span class="va">fs_mosquito_20_21</span>,</span>
<span>      fs_mosquito_16_17 <span class="op">=</span> <span class="va">fs_mosquito_16_17</span>,</span>
<span>      fs_mosquito_17_18 <span class="op">=</span> <span class="va">fs_mosquito_17_18</span>,</span>
<span>      fs_mosquito_18_19 <span class="op">=</span> <span class="va">fs_mosquito_18_19</span>,</span>
<span>      .id <span class="op">=</span> <span class="st">"dataset"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># post processing</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_data</span>,</span>
<span>    <span class="fu">combine_fs_mosquito_field</span><span class="op">(</span><span class="va">fs_mosquito_data_comb</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># read in existing validation log if exists</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_field_existing_log</span>,</span>
<span>    <span class="fu">ohcleandat</span><span class="fu">::</span><span class="fu"><a href="../reference/get_dropbox_val_logs.html">get_dropbox_val_logs</a></span><span class="op">(</span></span>
<span>      file_name <span class="op">=</span> <span class="st">"log_fs_mosquito_field.csv"</span>,</span>
<span>      path_name <span class="op">=</span> <span class="st">"dropbox/validation_logs"</span>,</span>
<span>      folder <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span>,</span>
<span>    cue <span class="op">=</span> <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_cue</span><span class="op">(</span><span class="st">"always"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># clean the data using the existing validation log</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_field_semiclean</span>,</span>
<span>    <span class="fu">ohcleandat</span><span class="fu">::</span><span class="fu"><a href="../reference/correct_data.html">correct_data</a></span><span class="op">(</span></span>
<span>      validation_log <span class="op">=</span> <span class="va">fs_mosquito_field_existing_log</span>,</span>
<span>      data <span class="op">=</span> <span class="va">fs_mosquito_data</span>,</span>
<span>      primary_key <span class="op">=</span> <span class="st">"key"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co">#   # validation cleaning checks</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">fs_mosquito_field_cleaning_checks</span>,</span>
<span>    <span class="fu">ohcleandat</span><span class="fu">::</span><span class="fu"><a href="../reference/validation_checks.html">validation_checks</a></span><span class="op">(</span></span>
<span>      validation_log <span class="op">=</span> <span class="va">fs_mosquito_field_existing_log</span>,</span>
<span>      before_data <span class="op">=</span> <span class="va">fs_mosquito_data</span>,</span>
<span>      after_data <span class="op">=</span> <span class="va">fs_mosquito_field_semiclean</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># upload semiclean data</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">upload_fs_mosquito_field_semiclean</span>,</span>
<span>    <span class="fu">ohcleandat</span><span class="fu">::</span><span class="fu"><a href="../reference/dropbox_upload.html">dropbox_upload</a></span><span class="op">(</span></span>
<span>      <span class="va">fs_mosquito_field_semiclean</span>,</span>
<span>      file_path <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"outputs/semiclean_fs_mosquito_field.csv"</span><span class="op">)</span>,</span>
<span>      dropbox_path <span class="op">=</span> <span class="st">"dropbox/semi_clean_data"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    cue <span class="op">=</span> <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_cue</span><span class="op">(</span><span class="st">"always"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Initializing rules which are defined as a function</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span><span class="va">rules_fs_mosquito_field</span>, <span class="fu">create_rules_fs_mosquito_field</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># mapping through rules to create a validation log</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">log_fs_mosquito_field</span>,</span>
<span>    <span class="fu">map_df</span><span class="op">(</span></span>
<span>      <span class="va">rules_fs_mosquito_field</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">13</span>, <span class="fl">14</span><span class="op">)</span><span class="op">]</span>,</span>
<span>      <span class="op">~</span> <span class="fu">ohcleandat</span><span class="fu">::</span><span class="fu"><a href="../reference/create_validation_log.html">create_validation_log</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">fs_mosquito_field_semiclean</span>,</span>
<span>        rule_set <span class="op">=</span> <span class="va">.x</span>,</span>
<span>        pkey <span class="op">=</span> <span class="st">"key"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Combine new validation violations with existing log</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">log_fs_mosquito_field_combined</span>,</span>
<span>    <span class="fu">ohcleandat</span><span class="fu">::</span><span class="fu"><a href="../reference/combine_logs.html">combine_logs</a></span><span class="op">(</span>existing_log <span class="op">=</span> <span class="va">fs_mosquito_field_existing_log</span>, new_log <span class="op">=</span> <span class="va">log_fs_mosquito_field</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># uploading to dropbox</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">upload_log_fs_mosquito_field_dropbox</span>,</span>
<span>    <span class="fu">ohcleandat</span><span class="fu">::</span><span class="fu"><a href="../reference/dropbox_upload.html">dropbox_upload</a></span><span class="op">(</span></span>
<span>      log <span class="op">=</span> <span class="va">log_fs_mosquito_field_combined</span>,</span>
<span>      file_path <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"outputs/log_fs_mosquito_field.csv"</span><span class="op">)</span>,</span>
<span>      dropbox_path <span class="op">=</span> <span class="st">"dropbpx/validation_logs"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    cue <span class="op">=</span> <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_cue</span><span class="op">(</span><span class="st">"always"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Rendering a HTML report for archival and emailing</span></span>
<span>  <span class="fu">tarchetypes</span><span class="fu">::</span><span class="fu">tar_render</span><span class="op">(</span></span>
<span>    <span class="va">report_fs_mosquito_field</span>,</span>
<span>    path <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"reports/RVF2_FS_Mosquito_Field.Rmd"</span><span class="op">)</span>,</span>
<span>    output_dir <span class="op">=</span> <span class="st">"outputs"</span>,</span>
<span>    knit_root_dir <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># target to identify report path</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">html_files_fs_mosquito_field</span>,</span>
<span>    <span class="fu">containerTemplateUtils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/containerTemplateUtils/man/get_file_paths.html" class="external-link">get_file_paths</a></span><span class="op">(</span><span class="va">report_fs_mosquito_field</span>, pattern <span class="op">=</span> <span class="st">"\\.html$"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Upload and archive report to AWS S3</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">deploy_automations_report_fs_mosquito_field</span>,</span>
<span>    <span class="fu">containerTemplateUtils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/containerTemplateUtils/man/aws_s3_upload.html" class="external-link">aws_s3_upload</a></span><span class="op">(</span></span>
<span>      path <span class="op">=</span> <span class="va">html_files_fs_mosquito_field</span>,</span>
<span>      prefix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s%s/"</span>, <span class="va">git_prefix</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      bucket <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"AWS_BUCKET"</span><span class="op">)</span>,</span>
<span>      error <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      file_type <span class="op">=</span> <span class="st">"html"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    cue <span class="op">=</span> <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_cue</span><span class="op">(</span><span class="st">"always"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Create a custom URL for hyperlink</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">url_fs_mosquito_field</span>,</span>
<span>    <span class="fu">ohcleandat</span><span class="fu">::</span><span class="fu"><a href="../reference/make_report_urls.html">make_report_urls</a></span><span class="op">(</span><span class="va">deploy_automations_report_fs_mosquito_field</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Blast out email</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">email_updates_fs_mosquito_field</span>,</span>
<span>    command <span class="op">=</span></span>
<span>      <span class="fu">containerTemplateUtils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/containerTemplateUtils/man/send_email_update_tar.html" class="external-link">send_email_update_tar</a></span><span class="op">(</span></span>
<span>        to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"EMAIL_RECIPIENTS_TEST"</span><span class="op">)</span>, <span class="st">";"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>        from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"EMAIL_SENDER"</span><span class="op">)</span>,</span>
<span>        project_name <span class="op">=</span> <span class="st">"RVF1 &amp; RVF2 FS Mosquito Field data"</span>,</span>
<span>        attach <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        attachment_paths <span class="op">=</span> <span class="va">html_files_fs_mosquito_field</span>,</span>
<span>        use_hyperlinks <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        hyperlinks_text <span class="op">=</span> <span class="st">"Archived Report"</span>,</span>
<span>        hyperlinks_url <span class="op">=</span> <span class="va">url_fs_mosquito_field</span>,</span>
<span>        test <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span>,</span>
<span>    cue <span class="op">=</span> <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_cue</span><span class="op">(</span><span class="st">"always"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="dag">DAG<a class="anchor" aria-label="anchor" href="#dag"></a>
</h3>
<p>A directed acyclic graph of a {targets} pipeline is shown below for a
real example.</p>
<p><img src="img%2Ftargets.png"></p>
</div>
<div class="section level3">
<h3 id="revised-pipeline">Revised pipeline<a class="anchor" aria-label="anchor" href="#revised-pipeline"></a>
</h3>
<p>In actual fact, after reading through the targets pipeline, a
refinement is required to our flow chart to reflect how the pipeline
works beyond its initial creation.</p>
<p>To ensure validation log corrections are applied correctly, any
existing validation log is read in first. The raw data are then
corrected and the validation log is re-run on the ‘semi-clean’ data so
as to only flag new violations that were not already reviewed and
corrected. Any new violation are appended to the existing log and
uploaded to Dropbox.</p>
<p><img src="img%2Fpipeline2.png"></p>
</div>
</div>
<div class="section level2">
<h2 id="complex-cases">Complex Cases<a class="anchor" aria-label="anchor" href="#complex-cases"></a>
</h2>
<p>In some cases, such as with questionnaire data, multiple different
logs are created and combined together - increasing the complexity.</p>
<p>Below is an example of combining multiple log types together:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># mapping through rules to create a validation log</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>targets<span class="sc">::</span><span class="fu">tar_target</span>(</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  log_animal_owner,</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="fu">map_df</span>(</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>    rules_animal_owner,</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>    <span class="sc">~</span> ohcleandat<span class="sc">::</span><span class="fu">create_questionnaire_log</span>(</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>      <span class="at">data =</span> animal_owner_semiclean,</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>      <span class="at">form_schema =</span> animal_owner_schema,</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>      <span class="at">rule_set =</span> .x,</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>      <span class="at">url =</span> <span class="st">"https://odk.xyz.io/#/projects/5/forms/survey/submissions"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>      <span class="at">pkey =</span> <span class="st">"id"</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>    )</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  )</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>),</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co"># create validation log records for free text requiring translation</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>targets<span class="sc">::</span><span class="fu">tar_target</span>(</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>  animal_owner_translation_log,</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>  ohcleandat<span class="sc">::</span><span class="fu">create_translation_log</span>(</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>    <span class="at">response_data =</span> animal_owner_semiclean,</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>    <span class="at">form_schema =</span> animal_owner_schema,</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>    <span class="at">url =</span> <span class="st">"https://odk.xyz.io/#/projects/5/forms/survey/submissions"</span>,</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>  )</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>),</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co"># create validation log records for free text 'other' responses that may contain valid multi-options</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>targets<span class="sc">::</span><span class="fu">tar_target</span>(</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>  animal_owner_text_log,</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>  ohcleandat<span class="sc">::</span><span class="fu">create_freetext_log</span>(</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>    <span class="at">response_data =</span> animal_owner_semiclean,</span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>    <span class="at">form_schema =</span> animal_owner_schema,</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>    <span class="at">url =</span> <span class="st">"https://odk.xyz.io/#/projects/5/forms/survey/submissions"</span>,</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>    ,</span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>    <span class="at">questionnaire =</span> <span class="st">"animal_owner"</span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>  )</span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>  </span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>),</span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a><span class="co"># unite current-run logs</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>targets<span class="sc">::</span><span class="fu">tar_target</span>(</span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>  logs_all_animal_owner,</span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>    log_animal_owner,</span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>    animal_owner_translation_log,</span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>    animal_owner_text_log</span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>  )</span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a>),</span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a></span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a><span class="co"># Combine new validation violations with existing log</span></span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a>targets<span class="sc">::</span><span class="fu">tar_target</span>(</span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a>  log_animal_owner_combined,</span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a>  ohcleandat<span class="sc">::</span><span class="fu">combine_logs</span>(<span class="at">existing_log =</span> animal_owner_existing_log, <span class="at">new_log =</span> logs_all_animal_owner)</span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="more-info">More info<a class="anchor" aria-label="anchor" href="#more-info"></a>
</h2>
<p>For more info on using {targets} see here: <a href="https://ecohealthalliance.github.io/eha-ma-handbook/3-projects.html#targets" class="external-link uri">https://ecohealthalliance.github.io/eha-ma-handbook/3-projects.html#targets</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Collin Schwantes, Johana Teigen, Ernest Guevarra, Dean Marchiori, Melinda Rostal, EcoHealth Alliance.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
